# APNG Generator V121 リリースノート

**リリース日:** 2026年1月3日  
**前バージョン:** V120 → **新バージョン:** V121

---

## 📋 概要

V121では、**「画質」「安定性」「効率」**の3点を徹底的に改善しました。圧縮ロジックの完全刷新により、フルカラーでの高画質生成が可能になったほか、退場エフェクトの残像問題や生成中のフリーズ問題など、ユーザー体験を損なっていた課題を包括的に解決しています。

**主なハイライト:**
- フルカラー（1677万色）生成への対応
- 退場エフェクトの透明度問題（残像）の完全修正
- Worker導入によるUIフリーズ解消
- 賢い自動リトライシステム

---

## 🆕 新機能・改善

### 1. 圧縮・画質ロジックの刷新
| 機能 | 説明 |
|-----|------|
| **フルカラー生成** | 容量に余裕がある場合、減色を行わずフルカラー（1677万色）で生成します（最大2000px） |
| **動的画質調整** | ココフォリアの画像制限「5MB以下」に収まるよう、制限ギリギリの高画質を保てるよう調整しました |
| **生成時間の目安** | 10〜30秒程度で完了します（画像サイズやエフェクトにより変動） |
| **推測精度の向上** | 全エフェクトの圧縮予測係数を再計算し、初回から最適な設定を推測します |
| **自動リトライ** | 生成結果がサイズ制限を超過した場合、自動的に画質を一段階下げて再生成します |

### 2. エフェクト改善
| 機能 | 説明 |
|-----|------|
| **退場エフェクト修正** | `swordSlashOut` 等の退場時に画像が完全消滅せず残像が残る問題を修正 |
| **透明度保持** | UPNGライブラリのクロップ機能を回避する独自処理を実装 |

### 3. パフォーマンス・UI
| 機能 | 説明 |
|-----|------|
| **非同期生成 (Worker)** | 重いエンコード処理をバックグラウンド化。生成中もブラウザが固まりません |
| **スムーズなプログレス** | 進捗バーが滑らかに動作するように改善 |

---

## 🔧 バグ修正

| 問題 | 修正内容 |
|-----|---------|
| **退場時の残像** | 最終フレームがクロップされて透明にならない問題を、全画面Alpha埋めで解決 |
| **ループ設定** | 「ループなし」を選択しても無限ループになる問題をバイナリ直接編集で修正 |
| **UIフリーズ** | 生成開始直後に画面が操作不能になる問題を解消 |

---

## 📁 主要な変更ファイル

### システム・ロジック
- `APNGGenerator.tsx` - ロジック全面刷新
- `public/apng.worker.js` - Worker処理の拡張
- `public/upng.custom.js` - **[New]** クロップ回避用カスタムライブラリ

### ドキュメント
- `docs/apng-v121-dev-spec.md` - **[New]** V121開発仕様書

---

## 📝 備考

- **検証結果:** 5MB制限下で、90%以上のケースでフルカラー生成に成功（以前は15%程度）
- **推奨環境:** 最新のChrome, Firefox, Safari, Edge
