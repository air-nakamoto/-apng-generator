# V121 圧縮ロジック修復・最適化計画

## 概要
失われてしまった圧縮ロジックを復元し、さらにユーザー要望に基づいた最適化と設計思想を反映させる計画です。
本ドキュメントは、AIセッションの切断等によるロジックの喪失を防ぐための恒久的な仕様書として機能します。

## 設計思想 (Design Philosophy)
圧縮ステップで目指すべきは、以下の両立です：
1.  **使用制限ギリギリの高画質**: 安易に画質を落とさず、制限内に収まる最高品質を狙う。
2.  **サイズ維持**: 過度な縮小を避け、元の画像サイズ・品質を可能な限り維持する。
3.  **高速生成**: 試行錯誤による待ち時間を最小化する。

## 実装仕様

### 1. 初期リサイズ (Base Scale) - V121.4更新
画像読み込み時および生成開始時に、以下の基準でリサイズ判定を行います。
- **1MB制限時:** 長辺 **1000px** 以下
- **5MB制限時:** 長辺 **1200px** 以下

※V121.3以前は1000px/1200pxだったが、制限ギリギリの高画質を狙うため引き上げ

### 2. 9段階の圧縮ステップ（V121.4 フルカラー対応）
以下の順序で最適な設定を探索します。画質優先で上から順に評価されます。

1.  **Step 1**: フルカラー, **100%** (Base Scaleのまま)
    - 最優先。最高画質。
2.  **Step 2**: フルカラー, **85%**
    - 色数は維持し、サイズを落とす。
3.  **Step 3**: フルカラー, **70%**
    - 色数は維持し、サイズをさらに落とす。
4.  **Step 4**: 256色, **100%**
    - 色数を減らす。
5.  **Step 5**: 256色, **85%**
    - 色数を減らし、サイズを落とす。
6.  **Step 6**: 256色, **70%**
    - 色数を減らし、サイズをさらに落とす。
7.  **Step 7**: 128色, **60%**
    - 色数・サイズ共に落とす。
8.  **Step 8**: 64色,  **50%**
    - 色数・サイズ共に大きく落とす。
9.  **Step 9**: 64色,  **30%**
    - 最終防衛ライン。

### 3. 縮小版実測ロジック（V121.4 最終版）
従来の1フレームテストでは推定精度が低かったため、固定200pxで実際にAPNGを生成して測定する方式に変更。

#### 処理フロー

1.  **固定200pxテスト生成**:
    - 長辺200pxの縮小版で全フレームのAPNGを生成
    - 実際のデルタ圧縮効果を反映した正確なサイズを測定
    - 画像サイズに関わらず一貫した高速テスト

2.  **スケール比 + 圧縮係数で推定**:
    ```
    推定サイズ = テストサイズ × スケール比 × 0.75
    ```
    - **スケール比**: 本番長辺 / テスト長辺（例: 2000px / 200px = 10倍）
    - **圧縮係数 0.75**: 実測データより、APNGはスケール比の約75%程度のサイズになる

3.  **最適ステップの決定**:
    - 推定サイズが制限以下の最初のステップを採用

4.  **本番生成**:
    - 決定されたステップで実際のAPNGを生成

#### 計算例

```
画像: 3014x3727px
5MB制限 → Base Scale 2000px → baseScale = 0.537

フルカラー85%のテスト:
- テストサイズ: 161x200px → 690KB
- 本番サイズ: 1374x1700px
- スケール比: 1700 / 200 = 8.5倍
- 推定: 690KB × 8.5 × 0.75 = 4.30MB
- 実際: 4.64MB
- 精度: 93%
```

#### 精度改善の履歴

| バージョン | 方式 | 利用率 |
|-----------|------|--------|
| V121.2 | 1フレーム×係数 | 17% |
| V121.4初期 | 縮小版×面積比16倍 | 16% |
| V121.4中期 | 縮小版×面積比4倍 | 68% |
| V121.4最終 | 縮小版×スケール比×0.75 | **93%** |

### 4. 退場効果の最終フレーム透明化ロジック

すべての退場効果（fadeOut, slideOut, wipeOut, zoomUpOut, sliceOut, tileOut, irisOut, pageFlipOut, cardFlipOut, glitchOut, blindOut, swordSlashOut, tvStaticOut, focusOut, pixelateOut）に対して、以下のルールを適用します。

**ルール: 「効果のみ」以外の場合、最終フレームを完全透明にする**

- **条件**: `effectIntensity !== 'none'` または `effectOption !== 'none'` の場合
- **動作**: 進行度（progress）が 95% 以上に達したら、そのフレームの描画をスキップ（break）して完全透明フレームを生成
- **理由**: ココフォリアでのシーン切り替え時に、前の画像が残らないようにするため

**実装例:**
```typescript
case 'fadeOut':
    if (effectIntensity !== 'none' || effectOption !== 'none') {
        if (progress >= 0.95) break // 最終フレームは完全透明（効果のみ以外）
    }
    ctx.globalAlpha = 1 - progress
    drawScaledImage(0, 0, canvas.width, canvas.height)
    ctx.globalAlpha = 1
    break
```

**注意事項:**
- プレビュー用コード、APNG生成用コード、両方に同じロジックを適用
- 進行度の閾値は 0.95 を基準とするが、効果によっては 0.9 や 0.99 に調整可能
- fadeOut のような元々フェード処理がある効果でも、確実に最終フレームを透明にするために追加

## 実装状況・現状報告

### 実装完了項目（2025年12月31日時点）

#### ✅ 圧縮ロジック
- [x] 8段階圧縮ステップ定義（APNGGenerator.tsx:1510-1520）- V121.3で拡張
- [x] 複数フレームテスト方式の実装（APNGGenerator.tsx:1525-1568）
- [x] 退場効果の自動判定（`transition.endsWith('Out')`）
- [x] 平均フレームサイズ計算（退場効果: 1/2、その他: 1倍）
- [x] 適切なマージン設定（1.2倍 = 20%）

#### ✅ 退場効果の透明化ロジック
- [x] プレビュー用: 全15種類の退場効果に実装完了
  - fadeOut, slideOut, wipeOut, zoomUpOut
  - sliceOut, tileOut, irisOut
  - pageFlipOut, cardFlipOut
  - tvStaticOut, glitchOut
  - blindOut, swordSlashOut
  - pixelateOut, focusOut
- [x] APNG生成用: 全15種類の退場効果に実装完了

#### ✅ UI改善
- [x] 推定容量と実際の容量を両方表示（APNGGenerator.tsx:3674-3681, 3733-3740）
- [x] 実際のサイズを緑色で強調表示
- [x] 生成完了後に「実際: X.XX MB (推定: Y.YY MB)」形式で表示

### 実測データと検証結果

#### テストケース1: ピクセレートアウト（3727px画像、5MB制限）

**1.1倍マージン（初期設定）:**
```
結果: 低品質ステップが選ばれる
推定: 5.44MB → 実際: 0.54MB（約10%）
問題: 5MBの10%しか使っておらず、設計思想に反する
```

**1.5倍マージン（第1次改善）:**
```
採用ステップ: 256色75%（727x900px）
推定: 4.63MB → 実際: 0.51MB（約11%）
問題: まだ5MBの10%程度しか使っていない
```

**2.5倍マージン（第2次改善）:**
```
採用ステップ: 128色60%（582x720px）
推定: 12.58MB → 実際: 0.32MB（約2.5%）
問題: マージンを増やしたのに推定が過大評価され、さらに低品質になった
原因: 退場効果の透明フレームを考慮していない
```

**複数フレームテスト方式（最終解決策）: ✅ 検証完了**
```
採用ステップ: 256色100%（970x1200px）✅
推定: 3.02MB → 実際: 0.83MB（約28%）
結果: 解像度が582x720→970x1200に大幅向上、ファイルサイズも0.32MB→0.83MBに向上
```

### 既知の問題

#### 1. Workerエラー
```
Error: Cannot read properties of undefined (reading 'deflate')
```
- **状態**: Fallbackが正常に動作しているため影響なし
- **原因**: public/apng.worker.js または public/upng.min.js の読み込み問題の可能性
- **優先度**: 低（機能に影響なし）

#### 2. 推定精度の課題
- **状況**: 退場効果では透明フレームが多いため、1フレームテストだけでは不正確
- **解決策**: 複数フレームテスト方式を実装済み
- **次のステップ**: 実際の生成で精度を検証

### 今後の計画・改善候補

#### 優先度: 高
- [ ] **複数フレームテスト方式の検証**: 実際に256色100%が選ばれるか、ファイルサイズが適切か確認
- [ ] **実測データの蓄積**: 様々な画像・効果でテストし、精度を確認

#### 優先度: 中
- [ ] **中間フレームの実測**: 現在は最初と最後だけだが、中間フレームも測定してより正確な推定
- [ ] **効果別マージン調整**: 効果によって透明フレームの割合が異なる可能性を考慮
- [ ] **Workerエラーの調査**: パフォーマンス向上のため解決を試みる

#### 優先度: 低
- [ ] **Base Scaleの上限調整**: 現在1200px、1600pxへの引き上げ検討
- [ ] **フルカラーオプション**: 色数制限なし（colorNum: 0）の最適化

### コード位置リファレンス

```
APNGGenerator.tsx:
  Line 101: compressionInfo state定義
  Line 1510-1520: 8段階圧縮ステップ定義（V121.3）
  Line 1525-1568: 複数フレームテスト実装
  Line 1529: 退場効果判定（transition.endsWith('Out')）
  Line 1546-1554: 平均フレームサイズ計算
  Line 1556: マージン設定（1.2倍）
  Line 2815: 実際のファイルサイズを記録
  Line 3674-3681: UI表示（生成中）
  Line 3733-3740: UI表示（完了時）

退場効果透明化ロジック:
  プレビュー: Line 267-890（全15種類）
  生成: Line 1588-2174（全15種類）
```

### 設計思想の達成度（V121.4 最終結果）

| 目標 | 実装 | 結果 | 達成度 |
|------|------|------|--------|
| 使用制限ギリギリの高画質 | 縮小版実測 + 圧縮係数0.75 | 93%利用率（4.64MB/5MB） | ✅ **達成** |
| サイズ維持 | Base Scale 2000px（5MB時） | フルカラー85% 1374x1700px | ✅ **達成** |
| 高速生成 | 固定200pxテスト | 即座にフェーズ表示 | ✅ **達成** |

#### 検証データ（5MB制限、3014x3727px画像）

| バージョン | 選択ステップ | 解像度 | 実サイズ | 利用率 |
|-----------|-------------|--------|----------|--------|
| V121.2以前 | 128色 | 970x1199 | 0.79MB | 16% |
| V121.4 | フルカラー85% | 1374x1700 | **4.64MB** | **93%** |

### バージョン履歴

- **V121.0** (2025-12-31): 初期実装
  - 圧縮ロジック復旧
  - 退場効果透明化ロジック実装（全15種類）
  - 1フレームテスト方式

- **V121.1** (2025-12-31): 推定精度改善
  - 実際のファイルサイズ表示機能追加
  - マージン調整（1.1倍→1.5倍→2.5倍）

- **V121.2** (2025-12-31): 複数フレームテスト方式
  - 退場効果の平均フレームサイズ計算実装
  - マージン最適化（1.2倍）
  - ✅ 検証完了

- **V121.3** (2025-12-31): 高解像度優先ステップ追加
  - 6段階 → 8段階に拡張
  - 256色90%、256色85% を追加
  - 100%〜75%間の細分化で最適解像度を探索

- **V121.4** (2025-12-31): 縮小版実測ロジック・フルカラー対応 ✅ 検証完了
  - Base Scale引き上げ（5MB: 1200→2000px、1MB: 1000→1400px）
  - フルカラー（colorNum: 0）ステップ追加（9段階に拡張）
  - 固定200px縮小版実測方式に変更
  - スケール比 × 圧縮係数0.75 で高精度推定
  - UIフェーズ表示追加（測定中/生成中/エンコード中）
  - ボタン押下直後にモーダル表示（即時フィードバック）
  - **検証結果**: 利用率17% → 93%に大幅改善、設計思想達成

- **V121.6** (2025-12-31): 登場エフェクト係数修正 ✅ 検証完了
  - HEAVY_MEDIUM (zoomUp, doorClose, cardFlipIn, sliceIn): 統一係数25.0
  - medium減色係数: 3.0 → 3.5
  - LIGHT_MEDIUM特別扱い削除（tileInは通常medium係数を使用）
  - **検証結果**: 全13テストケース成功（5MB以下達成）

- **V121.8** (2025-12-31): 初期サイズ最適化・フルカラー達成率向上
  - Base Scale変更:
    - 5MB制限: 2000px → **1200px**
    - 1MB制限: 1400px → **1000px**
  - 小さい画像対応: 200px以下の画像はそのままのサイズでテスト
  - **目的**: フルカラー達成率向上、スケール比縮小による推定精度向上

- **V121.9** (2025-12-31): Worker Error修正 ✅ 完了
  - `pako.min.js`を`public/`にコピー
  - `apng.worker.js`で`pako`を`upng`より先に読み込む
  - **原因**: UPNGがpako依存だがWorker環境でpakoがロードされていなかった

- **V121.10** (2025-12-31): 登場エフェクト再検証 ✅ 完了
  - 全15種類の登場エフェクトを実測
  - **成功率**: 12/15（80%）
  - **失敗**: zoomUp(11-22MB), doorClose(12MB), tvStaticIn(5-9MB)
  - **低利用率問題**: tileIn(5%), wipeIn(8%)等はフルカラーでも収まる可能性

- **V121.11** (2025-12-31): デルタ圧縮効率に基づく係数最適化 ✅ 実装
  - **3分類に細分化**:
    - 超高効率（wipe, tile, blind, iris）: 1.5/1.2
    - 中効率（fade, slide, focus等）: 3.5/2.5
    - 低効率（zoom, door, tvStatic）: 30.0/20.0
  - 退場エフェクトも同じ分類に対応

- **V121.12** (2025-12-31): サイズ超過時の自動リトライ ✅ 実装
  - 生成後に許容オーバー（5.3MB）を超過した場合、次のステップで再生成
  - UI表示: 「サイズ最適化中...」（プログレスは継続）
  - 推定精度100%を達成（リトライで必ず収まる）

- **V121.13** (2025-12-31): 本番エフェクト描画テスト ✅ 実装
  - テスト描画を本番と同じエフェクトに変更
  - 対応エフェクト: slideIn, wipeIn, zoomUp, doorClose, tvStaticIn, blindIn, irisIn, tileIn
  - 係数を大幅引き下げ（30.0→1.2）
  - 推定精度が飛躍的に向上

- **V121.14** (2025-01-01): サイズ超過時の複数回リトライ ✅ 実装
  - whileループで最大5回までリトライ
  - ステップを1つずつ下げて再生成
  - UI表示: 「サイズ最適化中...」（optimizingフェーズ）
  - コンソールログでリトライ過程を表示
  - **注意**: リトライ時はフェード描画（正確なエフェクト再現なし）

- **V121.15** (2025-01-01): エフェクト別係数の復活 ✅ 検証完了
  - **3分類に細分化**:
    - 超高効率（wipe, tile, blind, iris）: 1.2/1.0
    - 中効率（fade, slide, focus等）: 3.0/2.0
    - 低効率（zoom, door, tvStatic, enlarge, minimize）: 8.0/6.0
  - **検証結果**: zoomUp で 64色30%選択 → 1.50MB（リトライ不要で成功）
  - リトライ頻度を大幅削減

---

## V121.10 検証結果（登場エフェクト）

### テスト条件
- 画像: 女の子.png (3014x3727, 4.5MB)
- 制限: 5MB
- Base Scale: 1200px → 970x1200

### 実測サイズ一覧

| カテゴリ | エフェクト | 選択 | サイズ | 利用率 | 判定 |
|---------|-----------|------|--------|--------|------|
| 高効率 | tileIn | 256色100% | 0.27-0.35MB | 5-7% | ✅ (低すぎ) |
| 高効率 | wipeIn | 256色100% | 0.38-0.60MB | 8-12% | ✅ (低すぎ) |
| 高効率 | blindIn | 256色100% | 0.43-0.80MB | 9-16% | ✅ (低すぎ) |
| 複雑 | pixelateIn | 256色85% | 0.56-0.92MB | 11-18% | ✅ (低すぎ) |
| 高効率 | irisIn | 256色100% | 1.28-2.29MB | 27-46% | ✅ |
| 中効率 | focusIn | 256色100% | 1.71-2.76MB | 36-55% | ✅ |
| 中効率 | glitchIn | 256色85% | 1.77-1.89MB | 37-38% | ✅ |
| 中効率 | pageFlipIn | 256色100% | 1.79-1.91MB | 38% | ✅ |
| 中効率 | fadeIn | 256色100% | 2.31-2.42MB | 48% | ✅ |
| 中効率 | slideIn | 256色100% | 2.28-2.93MB | 48-59% | ✅ |
| 中効率 | cardFlipIn | 256色100% | 3.51-3.77MB | 74-75% | ✅ |
| 中効率 | sliceIn | 256色100% | 4.14-4.55MB | 87-91% | ✅ |
| **低効率** | **tvStaticIn** | 256色85% | **5.04-9.22MB** | **超過** | ❌ |
| **低効率** | **zoomUp** | フル100% | **11.2-21.7MB** | **超過** | ❌ |
| **低効率** | **doorClose** | フル100% | **12.1MB** | **超過** | ❌ |

### 問題分析

#### 超過問題（係数が低すぎ）
zoomUp/doorClose/tvStaticInはテスト描画が本番と異なるため推定不可

#### 低利用率問題（係数が高すぎ）
tileIn/wipeIn/blindIn等はフルカラーでも5MB以下に収まる可能性

---

## 残タスク（今後の計画）

### 1. 係数の細分化（優先度: 高）

デルタ圧縮効率に基づく3分類:
- **超高効率**（wipe, tile, blind, iris）: 1.5/1.2
- **中効率**（fade, slide, focus等）: 3.5/2.5  
- **低効率**（zoom, door, tvStatic）: 30.0/20.0

### 2. 退場・演出エフェクト係数調整（優先度: 中）

登場エフェクトの係数は検証済み。残り:
- 退場エフェクト（fadeOut, slideOut, etc.）
- 演出エフェクト（rotate, vibration, glitch, etc.）

### 3. テスト描画の改善（優先度: 中）

**現状の問題**:
- テスト描画がフェード近似（本番と異なる）
- スケール系エフェクトの推定が不正確

**改善案**:
- テスト描画を本番と同じエフェクトで実行
- 最も正確だが実装コスト高い

### 4. UIフリーズ改善（V121.20で解決済み）

~~テスト中にプログレスバーが停止する問題~~
- ~~原因: 同期処理でメインスレッドブロック~~
- ~~修正: 各ステップ間に `await setTimeout(0)` 挿入~~

**V121.20で完全解決:**
- `encodeApngWithWorker` を共通関数として抽出
- リトライ時のエンコードもWorkerで非同期実行
- これによりスピナーが最後まで止まらずに回り続ける

---

## 現在の係数設定（V121.15）

```typescript
// 超高デルタ効率（クリップ系）
const VERY_HIGH_EFFICIENCY = ['wipeIn', 'wipeOut', 'tileIn', 'tileOut', 'blindIn', 'blindOut', 'irisIn', 'irisOut']
compressionFactor = step.colorNum === 0 ? 1.2 : 1.0

// 中デルタ効率（移動・変形系）
// fadeIn, slideIn, focusIn, sliceIn, pageFlipIn, cardFlipIn, glitchIn, pixelateIn等
compressionFactor = step.colorNum === 0 ? 3.0 : 2.0

// 低デルタ効率（スケール・ノイズ系）
const LOW_EFFICIENCY = ['zoomUp', 'zoomUpOut', 'doorClose', 'doorOpen', 'tvStaticIn', 'tvStaticOut', 'enlarge', 'minimize']
compressionFactor = step.colorNum === 0 ? 8.0 : 6.0
```

## 現在の初期サイズ設定（V121.8）

| 制限 | 最大サイズ |
|------|-----------|
| 5MB | 1200px |
| 1MB | 1000px |

---

## V121.16-V121.20 変更履歴

### V121.16: ループなし設定修正
- UPNGライブラリは`loop`パラメータを無視して常に無限ループでエンコード
- 生成後にバイナリのacTLチャンクを直接修正して`num_plays`を設定
- `setApngLoopCount()` 関数を追加

### V121.17: completingフェーズ追加
- ダウンロード準備中もスピナーが回り続けるように

### V121.18: プログレスバー修正
- エンコード中の100%強制表示を削除
- リトライ時のプログレス更新を追加

### V121.19: UIへの制御戻し追加
- エンコード前後でsetTimeoutを追加してアニメーション継続

### V121.20: Workerリファクタリング（重要）
- `encodeApngWithWorker()` を共通関数として抽出
- `generateFramesAtScale()` → `generateFramesOnly()` に変更（エンコードなし）
- 初回エンコード・リトライ時どちらもWorkerで非同期実行
- **これによりUIフリーズ問題を完全解決**
